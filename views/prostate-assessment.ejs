<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prostate Cancer Risk Assessment</title>

  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
</head>

<body>

<header class="main-header">
  <div class="header-left">
    <span class="material-symbols-outlined header-icon">health_and_safety</span>
    <h2 class="header-title">Stay Informed</h2>
  </div>
</header>

<section class="card">

  <h2>Prostate Cancer Risk Assessment</h2>
  <p id="progress">Question 1 of 15</p>

  <!-- TEXT TO SPEECH -->
  <div class="tts-controls">
    <button id="speakBtn">
      <span class="material-symbols-outlined">volume_up</span>
    </button>
    <button id="stopBtn">
      <span class="material-symbols-outlined">stop</span>
    </button>
  </div>

  <form id="assessmentForm">

    <!-- QUESTIONS -->
    <div class="question active">
      <label>Are you 40 years or older?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Do you have a close relative diagnosed with prostate cancer?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Have you ever been told you are at higher risk for prostate cancer?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Do you smoke or have you smoked regularly in the past?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Do you experience difficulty starting urination?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Do you have a weak or interrupted urine stream?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Do you urinate frequently, especially at night?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Have you noticed pain in your lower back or hips?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Have you noticed blood in urine or semen?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <div class="question">
      <label>Have you experienced unexplained weight loss?</label>
      <div class="options">
        <button type="button" class="option" data-value="Yes">Yes</button>
        <button type="button" class="option" data-value="No">No</button>
      </div>
    </div>

    <!-- NAVIGATION -->
    <div class="nav-buttons">
      <button type="button" id="prevBtn" class="gradient-btn">Back</button>
      <button type="button" id="nextBtn" class="gradient-btn" disabled>Next</button>
    </div>

  </form>

  <!-- RESULT -->
  <div id="resultBox" class="hidden">
    <h3 id="resultTitle"></h3>
    <p id="resultMessage"></p>

    <button class="gradient-btn full-width" onclick="window.location.href='/prostate-resources'">
      Go to Educational Resources
    </button>
  </div>

</section>

<script>
  const questions = document.querySelectorAll(".question");
  const nextBtn = document.getElementById("nextBtn");
  const prevBtn = document.getElementById("prevBtn");
  const progress = document.getElementById("progress");
  const resultBox = document.getElementById("resultBox");
  const form = document.getElementById("assessmentForm");

  const speakBtn = document.getElementById("speakBtn");
  const stopBtn = document.getElementById("stopBtn");

  const CURRENT_USER_ID = "<%= userId %>";

  let current = 0;
  let answers = [];

  function showQuestion(index) {
    questions.forEach(q => q.classList.remove("active"));
    questions[index].classList.add("active");

    progress.textContent = `Question ${index + 1} of ${questions.length}`;
    prevBtn.style.display = index === 0 ? "none" : "inline-block";
    nextBtn.textContent = index === questions.length - 1 ? "Submit" : "Next";
    nextBtn.disabled = answers[index] === undefined;

    speakQuestion();
  }

  function speakQuestion() {
    if (!window.speechSynthesis) return;

    window.speechSynthesis.cancel();
    const text = questions[current].querySelector("label").innerText;
    const speech = new SpeechSynthesisUtterance(text);
    speech.rate = 0.95;
    speech.lang = "en-US";
    window.speechSynthesis.speak(speech);
  }

  speakBtn.onclick = speakQuestion;
  stopBtn.onclick = () => window.speechSynthesis.cancel();

  document.querySelectorAll(".options").forEach((group, index) => {
    group.querySelectorAll(".option").forEach(btn => {
      btn.addEventListener("click", () => {
        group.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
        btn.classList.add("selected");

        answers[index] = btn.dataset.value;
        nextBtn.disabled = false;
      });
    });
  });

  function calculateScore() {
    return answers.filter(a => a === "Yes").length;
  }

  function sendRiskToServer(level) {
    fetch("/prostate-cancer-risk", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: CURRENT_USER_ID, riskLevel: level })
    });
  }

  function showResult() {
    const score = calculateScore();
    let title = "", message = "";

    if (score <= 3) {
      title = "Low Risk / Low Immediate Concern";
      message = "Maintain healthy habits and regular check-ups.";
    } else if (score <= 6) {
      title = "Moderate Risk";
      message = "Screening and medical consultation are advised.";
    } else {
      title = "High Risk";
      message = "Immediate medical evaluation is strongly recommended.";
    }

    document.getElementById("resultTitle").textContent = title;
    document.getElementById("resultMessage").textContent = message;

    form.classList.add("hidden");
    progress.classList.add("hidden");
    resultBox.classList.remove("hidden");

    sendRiskToServer(title);
  }

  nextBtn.onclick = () => {
    if (current < questions.length - 1) {
      current++;
      showQuestion(current);
    } else {
      showResult();
    }
  };

  prevBtn.onclick = () => {
    if (current > 0) {
      current--;
      showQuestion(current);
    }
  };

  showQuestion(current);
</script>

</body>
</html>